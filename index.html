<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Section Signâ€‘In</title>
  <style>
    :root{
      --bg:#F6FFF9;          /* light background */
      --card:#FFFFFF;         /* card background */
      --border:#DDE8E2;       /* light border */
      --muted:#52636A;        /* subdued text */
      --text:#0b1020;         /* main text */
      --acc:#96CEB4;          /* primary accent (your light green) */
      --danger:#C0392B;       /* danger */
      --ok:#2E7D32;           /* success */
      --warn:#B8860B;         /* warning */
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:linear-gradient(180deg,#E8F7F0,#F6FFF9);} 
    header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter: blur(6px);border-bottom:1px solid var(--border);z-index:10}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{color:var(--text);font-size:clamp(20px,4vw,28px);margin:0}
    .sub{color:var(--muted);font-size:14px}
    main{max-width:1100px;margin:18px auto;padding:0 16px 40px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.06)}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:880px){.grid{grid-template-columns:1.4fr .9fr}}
    .list{padding:8px 0;max-height:70vh;overflow:auto;border-top-left-radius:16px;border-bottom-left-radius:16px}
    .row{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px dashed var(--border)}
    .row:last-child{border-bottom:none}
    .row span.name{flex:1;color:var(--text)}
    .row small{color:var(--muted)}
    .pill{font:12px/1.6 system-ui;padding:2px 8px;border-radius:999px;border:1px solid var(--acc);color:#245c49;background:rgba(150,206,180,.12)}
    .ok{color:var(--ok);border-color:#8fd3a6;background:rgba(46,125,50,.08)}
    .btn{appearance:none;border:1px solid #BEE3CF;background:#E7F5EE;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn:hover{filter:brightness(1.05)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-danger{border-color:#F1B0A6;background:#FDEDEC;color:#8B2F24}
    .btn-warn{border-color:#F1D7A7;background:#FFF7E6;color:#8A6D1D}
    .btn-ghost{background:transparent;border-color:var(--border)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .hidden{display:none}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px 8px;border-bottom:1px dashed var(--border);text-align:left;color:var(--text);font-size:14px}
    .table th{position:sticky;top:0;background:#F1FAF5;z-index:1}
    .muted{color:var(--muted)}
    code,kbd{background:#F1FAF5;border:1px solid var(--border);color:#1c3d2f;border-radius:6px;padding:0 6px}
    .foot{color:var(--muted);font-size:12px;margin-top:8px}
    .search{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#FFFFFF;color:var(--text)}
    .banner{padding:10px 14px;background:#FFF7E6;color:#8A6D1D;border-bottom:1px solid #F1D7A7}
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
      <div>
        <h1>Section Signâ€‘In</h1>
        <div class="sub">One check per device. No unchecks. Available only 6-7pm.</div>
      </div>
      <div class="toolbar">
        <button class="btn" id="instructorBtn" title="Instructor dashboard">Instructor Sign In</button>
      </div>
    </div>
  </header>

  <div id="timeBanner" class="banner hidden">Signâ€‘in is closed. Allowed time: 5:00â€“6:00 pm.</div>

  <main>
    <div class="grid">
      <!-- Student List -->
      <section class="card">
        <div style="padding:14px 14px 0;display:flex;gap:8px;align-items:center;justify-content:space-between">
          <input id="search" class="search" placeholder="Search studentsâ€¦" />
          <div class="pill"><span id="remainingInfo">â€”</span></div>
        </div>
        <div id="studentList" class="list" aria-live="polite"></div>
        <div style="padding:12px 14px" class="foot">A device can submit exactly once. If you checked the wrong name, contact the instructor to reset.</div>
      </section>

      <!-- Instructor Dashboard -->
      <aside class="card" id="instructorPanel" aria-hidden="true">
        <div style="padding:14px 14px 0;display:flex;align-items:center;justify-content:space-between">
          <h3 style="color:var(--text);margin:0">Instructor Dashboard</h3>
          <div class="toolbar">
            <button id="resetAll" class="btn btn-danger">Reset All</button>
            <button id="signOut" class="btn btn-ghost">Sign Out</button>
          </div>
        </div>
        <div style="padding:8px 14px 0" class="muted">Shows latest status, timestamp, and hashes. Public IP capture requires a backend.</div>
        <div style="padding:8px 14px 14px;max-height:70vh;overflow:auto">
          <table class="table" id="insTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Status</th>
                <th>Check Time</th>
                <th>Time Hash</th>
                <th>Device Hash</th>
                <th>IP</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </aside>
    </div>
  </main>

  <!-- Modal for Instructor Sign In -->
  <dialog id="authModal" style="border:none;border-radius:14px;padding:0;background:#0f1731;color:var(--text);">
    <form method="dialog" style="padding:18px 18px 12px;min-width:320px">
      <h3 style="margin:0 0 8px">Instructor Sign In</h3>
      <div class="muted" style="margin-bottom:10px">Enter passphrase to access resets and logs.</div>
      <input id="pass" type="password" placeholder="Passphrase" class="search" autofocus />
      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
        <button class="btn btn-ghost" value="cancel">Cancel</button>
        <button id="authGo" class="btn" value="go">Sign In</button>
      </div>
      <div id="authHint" class="foot"> </div>
    </form>
  </dialog>

<script>
/***********************
 * CONFIG
 ***********************/
const PASSPHRASE = 'instructor'; // ðŸ”’ Replace for real use
const SITE_SALT = 'uO-section-2025-10-02'; // used in hash generation
const DEVICE_LOCK_KEY = 'section.signin.device.locked.name';
const STORAGE_KEY = 'section.signin.v2';

// Allowed sign-in window (5â€“6pm local time). Adjust if needed.
const WINDOW_START_HOUR = 18; // 6pm
const WINDOW_END_HOUR   = 19; // 7pm (exclusive)

// Student roster
const STUDENTS = [
  "Acuna, Alana","Autar, Akash","Barnes, Aj","Bertelsen, Hailey","Bradshaw, Charlie","Cook Diaz, Rowan","Cooper, Mikala","Corcoran, Nick","Craddock, Yun","De Leon, Isaiah","Dennis, Kelsey","Ellorin, Ysabella","Enright, Taylor","Finemel, Annie","Freed, Drake","Friel, Liem","Fulk, Logan","Gomez-Chan, Fabiola","Hacker, Connor","Hansen, Reese","Hines, Nadia","Hussein, Rima","Kendall, Ava","Khanna, Ananya","Krueger, Tessa","Lage, Adeline","Lambo, Dexter","Lara, Diego","Lara, Victor","Leach, Gwendolynn","Lebo, Rachel","Lilly, Genevieve","Lucas, Grae","Maher, Kyle","Martin, Lea","Martinez, Marina","McDonald, Cam'Ron","Mehta, Jhil","Mosolgo, Anabella","Narbaez, Adrien","Nollette, Isabelle","Owens, Richie","Palmer, B J","Partain, Adrian","Petitt, McKenzie","Printz, Dane","Quizon, Ivanna","Rathore, Max","Roan, Dana","Robin, Aidan","Rook, Cassidy","Roscher, Wyatt","Rueter, Rochelle","Rutan, Triston","Sanada, Maia","Schmidt, Thomas","Schmitt, Eliot","Shaft, Isabella","Shepler, Izzy","Silvia, Noah","Spengler, Sascha","Tarbox, Michael","Toyooka, Luke","Uehara, Kierstin","Valdez, Bella","Walts, Benjamin","Watson, Magdalyn","Wenz, Kamryn","Winchester, Sierra","Wright, Jace"
].map(s=>s.trim());

// const STUDENTS = [
//   "Abraham, John", "Alamares, Miya", "Allen, Britany", "Altura, Leo", "Ayre, Nick", "Bamford, Annabelle", "Barnes, Lily", "Belforte, Bruno", "Besta, Emma", "Biggers, Avery", "Bond, Lulu", "Bunge, Grace", "Cabrera, Zach", "Capelle, Eloise", "Carlile, Zoie", "Carranza, Jasmine", "Chen, Shuyan", "Cheng, Brandon", "Coffin, Autumn", "Cronce, Ivory", "Domenigoni, Kaia", "Fogelmanis, Baylee", "Fowler, Liza", "Frails, Ezekiel", "Francis, Mia", "Garcia, Bri", "Gobel, Jacob", "Heinemann, Andreas", "Hinds, Mia", "Hornell, Payton", "Horyelov, Veronica", "Hudson, Hanna", "Humphries, Sam", "Jagare, Tilde", "Jenkins-Hiscox, Zoe", "Kayler, Sophia", "Kelley-Stephenson, Mercedes", "King, Hunter", "Lyons, Aramis", "Madriaga, Mckenzye", "Mason, Colin", "Mehta, Anika", "Meurisse, Lucas", "Miller, Hannah", "Morrison, Aidan", "Neuman, Caspian", "O'Connor, Keagan", "Olson, Vince", "Parish, Amelia", "Parry, Kris", "Paulk, Haviland", "Perry, Colin", "Queiroz, Nicholas", "Reynolds, Alexa", "Richardson, Emma", "Roberts, Ellie", "Rodenbaugh, Ella", "Roethe, Aspen", "Rutledge, Collin", "Speck, Logan", "Stangle, Aspen", "Suda, Sophia", "Tabor, Alice", "Thebert, Johanna", "Thompson, Ashlynn", "Tiegs, Ursula", "Toner, Grant", "Urtubey, Kaleb", "Van Norman Erickson, Arnica", "Vandehey, Nathan", "Weiner, Jake", "Yang, Sara"
// ].map(s=>s.trim());

/***********************
 * STORAGE
 ***********************/
const load = () => JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
const save = (obj) => localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));

function emptyRecord(name){
  return { name, status: 'unchecked', checkTime: null, timeHash: null, deviceHash: null, ip: null };
}

/***********************
 * CRYPTO HELPERS
 ***********************/
async function sha256Hex(str){
  const enc = new TextEncoder();
  const buf = await crypto.subtle.digest('SHA-256', enc.encode(str));
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
}

async function buildDeviceHash(){
  const ua = navigator.userAgent || '';
  const plat = navigator.platform || '';
  const lang = navigator.language || '';
  return await sha256Hex(`${SITE_SALT}|device|${ua}|${plat}|${lang}`);
}

async function buildTimeHash(name, iso){
  return await sha256Hex(`${SITE_SALT}|time|${name}|${iso}`);
}

/***********************
 * TIME WINDOW CONTROL
 ***********************/
function withinWindow(date=new Date()){
  const h = date.getHours();
  return h >= WINDOW_START_HOUR && h < WINDOW_END_HOUR;
}

function updateWindowUI(){
  const open = withinWindow();
  document.getElementById('timeBanner').classList.toggle('hidden', open);
}

/***********************
 * RENDER: STUDENT LIST
 ***********************/
const listEl = document.getElementById('studentList');
const remainingInfo = document.getElementById('remainingInfo');

function renderList(filter=''){
  const db = load();
  const q = filter.toLowerCase();
  listEl.innerHTML = '';
  const frag = document.createDocumentFragment();

  const lockedName = localStorage.getItem(DEVICE_LOCK_KEY);
  const windowOpen = withinWindow();

  STUDENTS.filter(n=>n.toLowerCase().includes(q)).forEach((name, idx) => {
    const rec = db[name] || emptyRecord(name);
    const row = document.createElement('div');
    row.className = 'row';

    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.checked = rec.status === 'checked';

    // Disable if outside time window, already checked someone else on this device, or this record already checked
    cb.disabled = !windowOpen || (lockedName && lockedName !== name) || rec.status === 'checked';
    cb.id = `cb-${idx}`;

    cb.addEventListener('change', async () => {
      // Only allow check ONCE; no unchecking
      if(!cb.checked){
        cb.checked = true; // snap back
        alert('Unchecking is not allowed. Contact instructor for a reset.');
        return;
      }

      // Enforce device lock
      const deviceLockedName = localStorage.getItem(DEVICE_LOCK_KEY);
      if(deviceLockedName && deviceLockedName !== name){
        cb.checked = false;
        alert('This device has already checked someone. You cannot check more than one person.');
        return;
      }

      const now = new Date();
      if(!withinWindow(now)){
        cb.checked = false;
        alert('Signâ€‘in is only available 6â€“7pm.');
        return;
      }

      const iso = now.toISOString();
      const newDB = load();
      const r = newDB[name] || emptyRecord(name);

      r.status = 'checked';
      r.checkTime = iso;
      r.timeHash = await buildTimeHash(name, iso);
      r.deviceHash = await buildDeviceHash();
      // r.ip remains null here; needs backend to populate reliably

      newDB[name] = r; save(newDB);
      localStorage.setItem(DEVICE_LOCK_KEY, name);

      refreshInstructor();
      renderList(document.getElementById('search').value);
    });

    const label = document.createElement('label');
    label.htmlFor = cb.id;
    label.style.display = 'contents';

    const nameSpan = document.createElement('span');
    nameSpan.className = 'name';
    nameSpan.textContent = name;

    const status = document.createElement('small');
    status.innerHTML = rec.status === 'checked' ? '<span class="pill ok">checked</span>' : '<span class="pill">not checked</span>';

    const left = document.createElement('small');
    left.className = 'muted';
    left.textContent = lockedName && lockedName !== name ? 'device locked' : (withinWindow() ? '' : 'closed');

    row.append(cb, label, nameSpan, status, left);
    frag.appendChild(row);
  });
  listEl.appendChild(frag);

  const totalChecked = STUDENTS.reduce((acc,n)=>{const r=(load()[n]||emptyRecord(n));return acc + (r.status==='checked');},0);
  remainingInfo.textContent = `${totalChecked} checked / ${STUDENTS.length}`;
}

/*************************
 * INSTRUCTOR DASHBOARD
 *************************/
const insPanel = document.getElementById('instructorPanel');
const insTBody = document.querySelector('#insTable tbody');

function renderInsRow(rec){
  const tr = document.createElement('tr');
  const fmt = (iso)=> iso? new Date(iso).toLocaleString(): '';
  tr.innerHTML = `
    <td>${rec.name}</td>
    <td>${rec.status === 'checked' ? '<span class="pill ok">checked</span>' : '<span class="pill">not checked</span>'}</td>
    <td class="muted">${fmt(rec.checkTime)}</td>
    <td><code>${rec.timeHash ? rec.timeHash.slice(0,12)+'â€¦' : ''}</code></td>
    <td><code>${rec.deviceHash ? rec.deviceHash.slice(0,12)+'â€¦' : ''}</code></td>
    <td class="muted">${rec.ip || ''}</td>
    <td>
      <button class="btn btn-warn" data-act="reset" data-name="${rec.name}">Reset</button>
    </td>`;
  return tr;
}

function refreshInstructor(){
  const db = load();
  insTBody.innerHTML = '';
  STUDENTS.forEach(name => {
    const rec = db[name] || emptyRecord(name);
    insTBody.appendChild(renderInsRow(rec));
  });
}

// Delegate button clicks (perâ€‘user reset)
insTBody.addEventListener('click', e => {
  const btn = e.target.closest('button[data-act="reset"]');
  if(!btn) return;
  const name = btn.getAttribute('data-name');
  const db = load();
  db[name] = emptyRecord(name);
  save(db);
  // If this device had locked this name, clear the device lock to allow a correction on THIS browser
  const lockedName = localStorage.getItem(DEVICE_LOCK_KEY);
  if(lockedName === name){
    localStorage.removeItem(DEVICE_LOCK_KEY);
  }
  refreshInstructor();
  renderList(document.getElementById('search').value);
});

// Reset all
document.getElementById('resetAll').addEventListener('click', () => {
  if(!confirm('Reset all students? This clears all statuses and hashes.')) return;
  const db = {};
  STUDENTS.forEach(n=>db[n]=emptyRecord(n));
  save(db);
  // Clear device lock for this browser
  localStorage.removeItem(DEVICE_LOCK_KEY);
  refreshInstructor();
  renderList(document.getElementById('search').value);
});

/***********************
 * AUTH MODAL
 ***********************/
const authModal = document.getElementById('authModal');
const passInput = document.getElementById('pass');

function requireAuth(){
  authModal.showModal();
  passInput.value='';
  setTimeout(()=>passInput.focus(), 50);
}

function openInstructor(){
  insPanel.classList.remove('hidden');
  insPanel.setAttribute('aria-hidden','false');
  refreshInstructor();
}

function closeInstructor(){
  insPanel.classList.add('hidden');
  insPanel.setAttribute('aria-hidden','true');
}

// Initial state: instructor panel hidden
closeInstructor();

// open modal
document.getElementById('instructorBtn').addEventListener('click', requireAuth);

// handle auth
document.getElementById('authGo').addEventListener('click', (e) => {
  e.preventDefault();
  if(passInput.value === PASSPHRASE){
    authModal.close();
    openInstructor();
  } else {
    alert('Incorrect passphrase');
  }
});

// sign out
document.getElementById('signOut').addEventListener('click', closeInstructor);

/***********************
 * SEARCH + INIT + CLOCK
 ***********************/
const search = document.getElementById('search');
search.addEventListener('input', (e)=> renderList(e.target.value));

(function init(){
  // Ensure all students exist in storage
  const db = load();
  let changed = false;
  STUDENTS.forEach(n=>{ if(!db[n]){ db[n] = emptyRecord(n); changed = true; } });
  if(changed) save(db);
  updateWindowUI();
  renderList();
  // Update time banner every minute
  setInterval(()=>{ updateWindowUI(); renderList(document.getElementById('search').value); }, 60_000);
})();
</script>
</body>
</html>
